<!-- templates/login.html -->
{% extends "layout.html" %}

{% block title %}Orçamento{% endblock %}

{% block content %}
<div class="container">
    <h1>Sistema de Orçamento</h1>
  <form id="budget-form">
    <div class="mb-3">
        <label for="city" style="font-size: small; font-weight: bold;">Cidade do Técnico</label>
        <select class="form-select" id="city">
        <option value="campinas">Campinas</option>
        <option value="goiania">Goiânia</option>
        <option value="sao_paulo">São Paulo</option>
        <option value="salvador">Salvador</option>
        </select>
    </div>

    <div class="mb-3">
        <label for="especie" style="font-size: small; font-weight: bold;">Cidade Do Serviço</label>
        <select id="serviceCity" class="form-select" name="serviceCity">
            <option value="">Selecionar Cidade</option>
        </select>
    </div>

    <div class="mb-3">
        <label for="service"  style="font-size: small; font-weight: bold;">Selecione o serviço:</label>
        <select class="form-select" id="service">
        <option value="">Selecione...</option>
        <option value="localizacao_vazamento">Localização De Vazamento</option>
        <option value="localizacao_infiltracao">Localização De Infiltração</option>
        </select>
    </div>
    <div class="mb-3" id="additional-fields"></div>

    <div class="mb-3">
        <button type="button" id="calculate-btn" style="width:100%">Calcular</button>
    </div>
  </form>
  <p id="taxa-deslocamento"></p>
  <p id="result"></p>
</div>

<script>
    const serviceSelect = document.getElementById('service');
    const additionalFields = document.getElementById('additional-fields');
    const calculateBtn = document.getElementById('calculate-btn');
    const result = document.getElementById('result');
    const taxaDeslocamento = document.getElementById('taxa-deslocamento');
    
    // Tabela de preços fixos
    const pricingTable = {
      campinas: {
        localizacao_vazamento: { 1: 280, 2: 330, 3: 380, 4: 430, 5: 480, 6: 530, 7: 580, 8: 630, 9: 680, 10: 730 },
        localizacao_infiltracao: { 1: 400, 2: 500 },
      },
      goiania: {
        localizacao_vazamento: { 1: 250, 2: 280, 3: 300, 4: 350, 5: 400, 6: 500, 7: 650, 8: 750, 9: 850, 10: 1000 },
        localizacao_infiltracao: { 1: 300, 2: 400 },
      },
      sao_paulo: {
        localizacao_vazamento: { 1: 400, 2: 500 },
        localizacao_infiltracao: { 1: 450, 2: 550 },
      },
      salvador: {
        localizacao_vazamento: { 1: 250, 2: 300, 3: 350, 4: 400, 5: 450, 6: 500, 7: 550, 8: 600, 9: 650, 10: 700 },
        localizacao_infiltracao: { 1: 350, 2: 450 },
      },
    };
    
    // Atualizar os campos adicionais com base no serviço selecionado
    serviceSelect.addEventListener('change', () => {
      additionalFields.innerHTML = ''; // Limpar campos anteriores
      const selectedService = serviceSelect.value;
    
      if (selectedService === 'localizacao_vazamento') {
        additionalFields.innerHTML = `
          <label for="bathrooms">Número de banheiros:</label>
          <select class="form-select" id="bathrooms">
            <option value="1">1</option>
            <option value="2">2</option>
          </select>
        `;
      } else if (selectedService === 'localizacao_infiltracao') {
        additionalFields.innerHTML = `
          <label for="infiltration_points">Número de pontos de infiltração:</label>
          <select class="form-select" id="infiltration_points">
            <option value="1">1</option>
            <option value="2">2</option>
          </select>
        `;
      }
    });

    const city = document.getElementById("city");
    const serviceCity = document.getElementById("serviceCity");

    const optionsMap = {
        "campinas": [
            {value: 0, text: "Campinas"},
            {value: 100, text: "Jundiaí"},
            
        ],
        "goiania": [
            {value: 0, text: "Senador Canedo"},
            {value: 0, text: "Trindade"},
            
        ],
    };

    city.addEventListener("change", function () {
        const selectedValue = city.value;

        // Limpa o segundo select
        serviceCity.innerHTML = "<option value=''>Selecione uma Cidade</option>";

        // Se houver uma opção válida no primeiro select
        if (optionsMap[selectedValue]) {
            // Adiciona as novas opções no segundo select
            optionsMap[selectedValue].forEach(option => {
                const newOption = document.createElement("option");
                newOption.value = option.value;
                newOption.text = option.text;
                serviceCity.appendChild(newOption);
            });
        }
    });
    
    // Calcular o orçamento
    calculateBtn.addEventListener('click', () => {
      const city = document.getElementById('city').value;
      const serviceCity = Number(document.getElementById('serviceCity').value);
      const service = serviceSelect.value;
    
      if (!city || !service) {
        result.textContent = 'Por favor, selecione a cidade e o serviço.';
        return;
      }
    
      const additionalField = service === 'localizacao_vazamento' ? 'bathrooms' : 'infiltration_points';
      const quantity = parseInt(document.getElementById(additionalField)?.value, 10);
    
      if (!quantity || !pricingTable[city][service][quantity]) {
        result.textContent = 'Por favor, selecione uma quantidade válida.';
        return;
      }
      
      const total = pricingTable[city][service][quantity] + serviceCity;

      taxaDeslocamento.textContent = `Taxa de Deslocamento R$ ${serviceCity.toFixed(2)}`;
      result.textContent = `O orçamento total é R$ ${total.toFixed(2)}`;
    });    
</script>
{% endblock %}